<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="keywords" content="ayabala 啊呀吧啦">
    <meta name="description" content="FantasyNJ的个人主页">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>ayabala 注册/登录</title>
    <link href="https://fonts.lug.ustc.edu.cn/css?family=Pattaya" rel="stylesheet">
    <link rel="stylesheet" href="./css/normalize.css">
    <link rel="stylesheet" href="./css/initial.css">
    <link rel="stylesheet" href="./css/login.css">
    <script>
        //已经登录，跳转到首页
        if(window.localStorage.getItem('username')){
            window.location.href = '/';
        }
    </script>
</head>
<body>
<h1><a href="/">ayabala</a></h1>
<section class="wrap">
    <section class="login-wrap">
        <form action="/api/login" method="post" class="login">
            <p class="prompt hint"></p>
            <input type="text" placeholder="用户名" name="username" autocomplete="off">
            <p class="username-tips hint"></p>
            <input type="password" placeholder="密码" name="password">
            <p class="password-tips hint"></p>
            <!--<input type="submit" value="登录">-->
            <button type="submit">登录</button>
        </form>
        <p class="to-register to-a"><a href="#register">没有账户？立即注册</a></p>
    </section>

    <section class="register-wrap">
        <form action="/api/register" method="post" class="register">
            <p class="prompt hint"></p>
            <input type="text" placeholder="用户名长度3-16个字符" name="username" autocomplete="off">
            <p class="username-tips hint"></p>
            <input type="password" placeholder="密码6-16个字符" name="password">
            <p class="password-tips hint"></p>
            <input type="password" placeholder="重复密码" name="repassword">
            <p class="repassword-tips hint"></p>
            <!--<input type="submit" value="注册">-->
            <button type="submit">注册</button>
        </form>
        <p class="to-login to-a"><a href="#login">已有账户，立即登录</a></p>
    </section>

</section>


<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script>
//切换模块
$(function(){

    if(window.location.hash === ''){
        window.location.hash = 'login';
    }
    hashTransform();

    $(window).on('hashchange', hashTransform);
    //hash值改变函数
    function hashTransform(){
        var hash = window.location.hash.replace('#', '');
        if(hash === 'login'){
            $('.login-wrap').css('display', 'block');
            $('.register-wrap').css('display', 'none');
        }else if(hash === 'register'){
            $('.register-wrap').css('display', 'block');
            $('.login-wrap').css('display', 'none');
        }
        $('.hint').each(function(index, item){
            $(item).text('');
        })
    }
})
//登录模块
$(function(){
    var form = $('.login');
    var prompt = $('.login .prompt');
    var usernameTips = $('.login .username-tips');
    var passwordTips = $('.login .password-tips');
    var username = $('.login input[name="username"]');
    var password = $('.login input[name="password"]');
    var submit = $('.login input[type="submit"]');


    form.on('submit',function(){
        var u = username.val().trim();
        var p = password.val().trim();
        $.ajax({
            type: 'POST',
            url: '/api/login',
            data: {
                username: u,
                password: p,
            },
            dataType: 'json',
            success: function(result){
                prompt.text( result.message );
                if (result.code) {
                    prompt.css('color', 'red');
                } else {
                    prompt.css('color', 'green');
                    localStorage.setItem('username', u);
                    window.location.href = '/';
                }
            }
        });
        return false;
    })
})
//注册模块
$(function(){
    var form = $('.register');
    var prompt = $('.register .prompt');
    var usernameTips = $('.register .username-tips');
    var passwordTips = $('.register .password-tips');
    var repasswordTips = $('.register .repassword-tips');
    var username = $('.register input[name="username"]');
    var password = $('.register input[name="password"]');
    var repassword = $('.register input[name="repassword"]');
    var submit = $('.register input[type="submit"]');

    username.blur(function(){
        var value = this.value.trim();
        if(value.length < 3 || value.length > 16){
            usernameTips.text('用户名长度必须在3-16个字符之间');
            usernameTips.css('color', 'red');
        }else{
            $.get('/api/checkusername', {username: value}, function(result){
                console.log(result);
                if (result.code) {
                    usernameTips.text('用户名已被注册');
                    usernameTips.css('color', 'red');
                } else {
                    usernameTips.text('用户名可以使用');
                    usernameTips.css('color', 'green');
                }
            })
        }
    })

    password.blur(function(){
        var value = this.value.trim();
        if(value.length < 6 || value.length > 16){
            passwordTips.text('密码长度必须在6-16个字符之间');
            passwordTips.css('color', 'red');
        }else{
            passwordTips.text('');
        }
    })

    repassword.blur(function(){
        var value = this.value.trim();
        if(value !== $(password).val().trim()){
            repasswordTips.text('密码不一致');
            repasswordTips.css('color', 'red');
        }else{
            repasswordTips.text('');
        }
    })

    form.on('submit',function(){
        var u = username.val().trim();
        var p = password.val().trim();
        var r = repassword.val().trim();
        $.ajax({
            type: 'POST',
            url: '/api/register',
            data: {
                username: u,
                password: p,
                repassword: r,
            },
            dataType: 'json',
            success: function(result){
                prompt.text( result.message );
                if (result.code) {
                    prompt.css('color', 'red');
                } else {
                    prompt.css('color', 'green');
                }
            }
        });
        return false;
    })
})
</script>
</body>
</html>